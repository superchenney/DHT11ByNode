var express=require("express"),router=express.Router(),Alidayu=require("../controller/alidayu/alidayu"),User=global.dbHandel.getModel("user"),UserConfirmCode=global.dbHandel.getModel("ucc"),TempHumidityRecord=global.dbHandel.getModel("thr"),WarningRecord=global.dbHandel.getModel("wr");router.get("/",function(e,o,n){o.render("index",{title:"首页"})}),router.get("/login",function(e,o,n){o.render("login")}),router.get("/setting",function(e,o,n){e.session.user?o.render("setting"):o.redirect("/")}),router.get("/warningRecord",function(e,o,n){e.session.user?WarningRecord.find({wpn:e.session.user.upn}).sort("-t").exec(function(e,n){e?console.log("数据库查询历史报警信息出错！"+e):o.render("warningRecord",{title:"历史记录",item:n})}):o.redirect("/")}),router.post("/setting",function(e,o,n){User.findOne({upn:e.session.user.upn},function(n,s){n?(o.send(500),console.log(n)):s?User.update({upn:e.session.user.upn},{$set:{wt:e.body.userTempSet,wl:e.body.userTempLock}},function(n,s){n?(console.log(n),o.send(500)):(console.log("用户设置更新"),e.session.user.wt=e.body.userTempSet,e.session.user.wl=e.body.userTempLock,o.redirect("/"))}):(o.send(404),console.log("用户"+e.session.user.upn+"不存在"))})}),router.get("/getUserInofo",function(e,o,n){if(e.session.user){var s={PhoneNum:e.session.user.upn,UserRole:e.session.user.ur,WarningLock:e.session.user.wl,WarningTemp:e.session.user.wt,UserCreateTime:e.session.user.uct};o.send(s)}else o.send("error")}),router.get("/getAllTempAndHumityInofo",function(e,o,n){TempHumidityRecord.find({}).sort("-t").limit(20).sort("t").exec(function(e,n){e?console.log("查询历史温湿度数据错误！"+e):o.send(n)})}),router.post("/login",function(e,o,n){User.findOne({upn:e.body.loginphoneNum},function(n,s){n?(o.send(500),console.log(n)):s?s.pwd!=e.body.loginPwd?(e.session.error="密码输入错误",o.sendStatus(200),o.send(),console.log(e.body.loginphoneNum+"密码错误")):(e.session.user=s,e.session.success="登录成功！",o.redirect("/")):(e.session.error="手机号未注册",console.log("用户"+e.body.loginphoneNum+"不存在"))})}),router.post("/regist",function(e,o,n){UserConfirmCode.findOne({upn:e.body.registPhoneNum},function(n,s){if(n)o.send(500),console.log(n);else if(s){var r=e.body.registCode,t=s.cc;r==t?(console.log("验证码一致"),User.create({upn:e.body.registPhoneNum,pwd:e.body.registPwdConfirm},function(n,s){n?(e.session.error="创建失败！",o.sendStatus(500),console.log(n)):(e.session.user=s,o.redirect("/setting"),console.log("用户创建成功！"))})):o.send(500)}else o.send(500)})}),router.post("/getRegistCode",function(e,o,n){function s(){var e=null;do e=Math.floor(1e4*Math.random());while(1e3>e);return e}var r=e.body.phoneNum,t=s();UserConfirmCode.findOne({upn:r},function(e,n){e?(o.send(500),console.log(e)):n?UserConfirmCode.update({upn:r},{$set:{cc:t}},function(e,n){e?console.log(e):(console.log("手机号码存在,验证码更新"),o.sendStatus(200))}):UserConfirmCode.create({upn:r,cc:t},function(e,n){if(e)o.sendStatus(500),console.log(e);else{console.log("验证码创建成功！");var s='{"code": "'+t+'","product": "温度实时监测报警系统"}';Alidayu.sendRegisterCode(s,r),o.sendStatus(200)}})})}),module.exports=router;